<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="theme-color" content="#1a1a2e">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ChitBook">
<meta name="mobile-web-app-capable" content="yes">
<title>ChitBook ‚Äî Chit Fund Organiser</title>
<link rel="manifest" href="./manifest.json">
<link rel="apple-touch-icon" href="./icon.svg">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0f0f1a; --surface:#1a1a2e; --surface2:#22223b; --surface3:#2d2d44;
  --accent:#f4a261; --accent2:#e76f51; --green:#52b788; --red:#e63946;
  --yellow:#ffd166; --blue:#4cc9f0;
  --text:#e8e8f0; --text2:#9999bb; --text3:#6666aa;
  --border:rgba(255,255,255,0.07); --radius:16px; --radius-sm:10px;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 20% 20%,rgba(244,162,97,.07) 0%,transparent 50%),radial-gradient(ellipse at 80% 80%,rgba(231,111,81,.05) 0%,transparent 50%);pointer-events:none;z-index:0}
.app{position:relative;z-index:1;max-width:480px;margin:0 auto;padding-bottom:90px}

/* HEADER */
.header{position:fixed;top:0;left:50%;transform:translateX(-50%);width:100%;max-width:480px;padding:14px 16px;display:flex;align-items:center;justify-content:space-between;background:rgba(15,15,26,.95);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);z-index:100}
.header-spacer{height:58px}
.logo{font-family:'Playfair Display',serif;font-size:20px;color:var(--accent)}
.logo span{color:var(--text3);font-weight:400;font-size:10px;display:block;font-family:'DM Sans',sans-serif;letter-spacing:.5px;margin-top:-1px}
.header-btn{background:var(--accent);color:#0f0f1a;border:none;padding:7px 14px;border-radius:20px;font-family:'DM Sans',sans-serif;font-weight:700;font-size:12px;cursor:pointer;transition:all .2s}
.header-btn:active{transform:scale(.96)}

/* PAGES */
.page{display:none;padding:14px 14px 0}
.page.active{display:block}

/* BOTTOM NAV */
.bottom-nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:480px;background:rgba(26,26,46,.97);backdrop-filter:blur(20px);border-top:1px solid var(--border);display:flex;padding:6px 0 18px;z-index:100}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;padding:6px;cursor:pointer;transition:all .2s;border:none;background:none;color:var(--text3);font-family:'DM Sans',sans-serif;font-size:10px;position:relative}
.nav-item.active{color:var(--accent)}
.nav-item svg{width:20px;height:20px}
.nav-badge{position:absolute;top:3px;right:50%;transform:translateX(12px);background:var(--red);color:#fff;font-size:9px;font-weight:700;min-width:16px;height:16px;border-radius:8px;display:flex;align-items:center;justify-content:center;padding:0 3px}

/* ALERTS */
.alert-box{border-radius:var(--radius);padding:13px 15px;margin-bottom:10px;display:flex;align-items:flex-start;gap:11px;cursor:pointer}
.alert-box.red{background:linear-gradient(135deg,rgba(230,57,70,.12),rgba(230,57,70,.05));border:1px solid rgba(230,57,70,.25)}
.alert-box.yellow{background:linear-gradient(135deg,rgba(255,209,102,.1),rgba(255,209,102,.04));border:1px solid rgba(255,209,102,.2)}
.alert-box.green{background:linear-gradient(135deg,rgba(82,183,136,.1),rgba(82,183,136,.04));border:1px solid rgba(82,183,136,.2)}
.alert-box.blue{background:linear-gradient(135deg,rgba(76,201,240,.1),rgba(76,201,240,.04));border:1px solid rgba(76,201,240,.2)}
.alert-icon{font-size:19px;flex-shrink:0;margin-top:1px}
.alert-title{font-weight:700;font-size:13px;margin-bottom:2px}
.alert-title.red{color:var(--red)} .alert-title.yellow{color:var(--yellow)} .alert-title.green{color:var(--green)} .alert-title.blue{color:var(--blue)}
.alert-desc{font-size:12px;color:var(--text2);line-height:1.5}

/* SUMMARY */
.summary-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
.summary-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:13px}
.lbl{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px}
.val{font-family:'DM Mono',monospace;font-size:18px;font-weight:500}
.val.accent{color:var(--accent)} .val.green{color:var(--green)} .val.red{color:var(--red)} .val.yellow{color:var(--yellow)}

/* CHIT CARD */
.chit-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:10px;cursor:pointer;transition:all .2s;position:relative;overflow:hidden}
.chit-card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--accent);border-radius:3px 0 0 3px}
.chit-card.urgent::before{background:var(--red)}
.chit-card.warning::before{background:var(--yellow)}
.chit-card:active{transform:scale(.98)}
.chit-card-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px}
.chit-name{font-family:'Playfair Display',serif;font-size:15px}
.badge{font-size:10px;padding:3px 9px;border-radius:20px;font-weight:600}
.badge.green{background:rgba(82,183,136,.15);color:var(--green)}
.badge.red{background:rgba(230,57,70,.15);color:var(--red)}
.badge.yellow{background:rgba(255,209,102,.15);color:var(--yellow)}
.badge.grey{background:rgba(153,153,187,.15);color:var(--text2)}
.chit-meta{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
.meta-item .lbl{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.6px}
.meta-item .val{font-family:'DM Mono',monospace;font-size:12px;margin-top:2px}
.progress-wrap{margin-top:12px}
.progress-label{display:flex;justify-content:space-between;font-size:10px;color:var(--text3);margin-bottom:4px}
.progress-bar{background:var(--surface3);border-radius:4px;height:3px;overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:4px;transition:width .5s}

/* SECTION */
.section-title{font-family:'Playfair Display',serif;font-size:17px;margin-bottom:12px}
.section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.text-btn{background:none;border:none;color:var(--accent);font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;padding:0}

/* DETAIL */
.back-btn{display:flex;align-items:center;gap:8px;color:var(--accent);font-size:13px;font-weight:500;cursor:pointer;margin-bottom:14px;border:none;background:none;padding:0}
.detail-hero{background:linear-gradient(135deg,var(--surface),var(--surface2));border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:12px}
.detail-title{font-family:'Playfair Display',serif;font-size:20px;margin-bottom:14px}
.detail-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.detail-stat .lbl{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.6px}
.detail-stat .val{font-family:'DM Mono',monospace;font-size:14px;margin-top:3px}

/* POOL CARD */
.pool-card{background:rgba(244,162,97,.07);border:1px solid rgba(244,162,97,.18);border-radius:var(--radius-sm);padding:13px 15px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center}
.pool-card .lbl{font-size:12px;color:var(--text2)}
.pool-card .sub{font-size:11px;color:var(--text3);margin-top:2px}
.pool-card .amount{font-family:'DM Mono',monospace;font-size:22px;color:var(--accent);font-weight:500}

/* AUCTION DATE CARD */
.adate-card{background:rgba(76,201,240,.07);border:1px solid rgba(76,201,240,.18);border-radius:var(--radius-sm);padding:12px 15px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center}
.adate-card .lbl{font-size:11px;color:var(--text2)}
.adate-card .dv{font-family:'DM Mono',monospace;font-size:14px;color:var(--blue)}
.adate-card .ds{font-size:12px;margin-top:2px}

/* TABS */
.tabs{display:flex;background:var(--surface2);border-radius:var(--radius-sm);padding:3px;margin-bottom:14px;gap:2px;overflow-x:auto;scrollbar-width:none}
.tabs::-webkit-scrollbar{display:none}
.tab-btn{flex:1;min-width:fit-content;padding:7px 10px;border-radius:7px;border:none;background:none;color:var(--text2);font-family:'DM Sans',sans-serif;font-size:12px;font-weight:500;cursor:pointer;transition:all .2s;white-space:nowrap}
.tab-btn.active{background:var(--surface);color:var(--text);font-weight:600}
.tab-pane{display:none}
.tab-pane.active{display:block}

/* MONTH TABS */
.month-tabs{display:flex;gap:6px;overflow-x:auto;padding-bottom:4px;margin-bottom:12px;scrollbar-width:none}
.month-tabs::-webkit-scrollbar{display:none}
.month-tab{flex-shrink:0;padding:5px 12px;border-radius:20px;font-size:11px;cursor:pointer;border:none;background:var(--surface2);color:var(--text2);font-family:'DM Sans',sans-serif;transition:all .2s}
.month-tab.active{background:var(--accent);color:#fff;font-weight:600}

/* MEMBER ROWS */
.member-row{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:11px 12px;margin-bottom:7px;display:flex;align-items:center;justify-content:space-between}
.member-row.overdue4{border-color:rgba(255,209,102,.3);background:rgba(255,209,102,.04)}
.member-row.overdue6{border-color:rgba(230,57,70,.3);background:rgba(230,57,70,.04)}
.member-row.org-row{border-color:rgba(244,162,97,.25);background:rgba(244,162,97,.04)}
.member-info{display:flex;align-items:center;gap:10px;flex:1;min-width:0;cursor:pointer}
.avatar{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;color:#fff;flex-shrink:0}
.avatar.org{background:linear-gradient(135deg,#f4a261,#e76f51)}
.avatar.def{background:linear-gradient(135deg,var(--red),#c1121f)}
.member-name{font-size:13px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.member-sub{font-size:11px;color:var(--text3);margin-top:1px}
.member-actions{display:flex;gap:5px;align-items:center;flex-shrink:0}

/* BUTTONS */
.pay-btn{background:rgba(82,183,136,.15);color:var(--green);border:none;padding:5px 10px;border-radius:20px;font-size:11px;font-weight:600;cursor:pointer}
.def-btn{background:rgba(230,57,70,.1);color:var(--red);border:none;padding:5px 9px;border-radius:20px;font-size:11px;font-weight:600;cursor:pointer}
.undo-btn{background:var(--surface2);color:var(--text2);border:none;padding:5px 8px;border-radius:20px;font-size:11px;cursor:pointer}
.wa-btn{background:rgba(37,211,102,.12);color:#25d366;border:none;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0}
.paid-badge{background:rgba(82,183,136,.1);color:var(--green);font-size:10px;padding:3px 9px;border-radius:20px;font-weight:600}
.payout-badge{background:rgba(244,162,97,.1);color:var(--accent);font-size:10px;padding:3px 8px;border-radius:20px;font-weight:600}
.def-badge{background:rgba(230,57,70,.1);color:var(--red);font-size:10px;padding:3px 9px;border-radius:20px;font-weight:600}
.overdue-badge{background:rgba(255,209,102,.12);color:var(--yellow);font-size:10px;padding:3px 8px;border-radius:20px;font-weight:600}

/* AUCTION */
.auction-box{background:linear-gradient(135deg,rgba(244,162,97,.09),rgba(231,111,81,.04));border:1px solid rgba(244,162,97,.2);border-radius:var(--radius);padding:15px;margin-bottom:14px}
.auction-result{background:var(--surface2);border-radius:var(--radius-sm);padding:12px;margin-top:12px;font-size:13px;color:var(--text2);line-height:1.7;display:none}
.auction-result strong{color:var(--accent)}

/* ORG PAYOUT */
.org-box{background:linear-gradient(135deg,rgba(244,162,97,.12),rgba(231,111,81,.06));border:1px solid rgba(244,162,97,.3);border-radius:var(--radius);padding:15px;margin-bottom:14px}

/* HISTORY */
.hist-row{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border)}
.h-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.h-dot.in{background:var(--green)} .h-dot.out{background:var(--accent)}
.h-desc{font-size:12px;flex:1}
.h-sub{font-size:10px;color:var(--text3);margin-top:1px}
.h-amt{font-family:'DM Mono',monospace;font-size:12px;flex-shrink:0}
.h-amt.in{color:var(--green)} .h-amt.out{color:var(--accent)}

/* REMINDERS */
.rem-row{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)}
.rem-row:last-child{border-bottom:none}
.send-all-btn{display:flex;align-items:center;justify-content:center;gap:7px;width:100%;background:rgba(37,211,102,.1);color:#25d366;border:1px solid rgba(37,211,102,.18);padding:10px;border-radius:var(--radius-sm);font-family:'DM Sans',sans-serif;font-weight:600;font-size:13px;cursor:pointer;margin-top:10px}
.wa-text-btn{display:flex;align-items:center;gap:5px;background:rgba(37,211,102,.1);color:#25d366;border:none;padding:5px 10px;border-radius:20px;font-size:11px;font-weight:600;cursor:pointer}

/* MODALS */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(4px);z-index:200;align-items:flex-end;justify-content:center}
.modal-overlay.active{display:flex}
.modal{background:var(--surface);border-radius:22px 22px 0 0;padding:18px 18px 40px;width:100%;max-width:480px;max-height:92vh;overflow-y:auto;animation:slideUp .3s ease}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-handle{width:36px;height:4px;background:var(--surface3);border-radius:2px;margin:0 auto 16px}
.modal-title{font-family:'Playfair Display',serif;font-size:19px;margin-bottom:16px}

/* FORMS */
.fg{margin-bottom:13px}
.fl{font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px;display:block}
.fi{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:11px 13px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;outline:none;transition:border-color .2s}
.fi:focus{border-color:var(--accent)}
.fi::placeholder{color:var(--text3)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
select.fi{appearance:none}
.info-box{background:rgba(244,162,97,.07);border:1px solid rgba(244,162,97,.14);border-radius:var(--radius-sm);padding:11px;font-size:12px;color:var(--text2);line-height:1.6;margin-bottom:13px}
.btn-primary{width:100%;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;border:none;padding:13px;border-radius:var(--radius-sm);font-family:'DM Sans',sans-serif;font-weight:700;font-size:14px;cursor:pointer;transition:all .2s;margin-top:5px}
.btn-primary:active{transform:scale(.98);opacity:.9}
.btn-secondary{width:100%;background:var(--surface2);color:var(--text2);border:1px solid var(--border);padding:12px;border-radius:var(--radius-sm);font-family:'DM Sans',sans-serif;font-weight:500;font-size:13px;cursor:pointer;margin-top:7px}
.whatsapp-btn{display:flex;align-items:center;justify-content:center;gap:8px;width:100%;background:rgba(37,211,102,.1);color:#25d366;border:1px solid rgba(37,211,102,.18);padding:12px;border-radius:var(--radius-sm);font-family:'DM Sans',sans-serif;font-weight:600;font-size:13px;cursor:pointer;margin-top:7px}

/* EMPTY */
.empty-state{text-align:center;padding:50px 20px;color:var(--text3)}
.empty-state svg{width:48px;height:48px;opacity:.2;margin-bottom:12px}
.empty-state h3{font-family:'Playfair Display',serif;font-size:16px;color:var(--text2);margin-bottom:6px}
.empty-state p{font-size:13px;line-height:1.6}

/* TOAST */
.toast{position:fixed;bottom:88px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:9px 18px;font-size:13px;color:var(--text);opacity:0;transition:all .3s;z-index:300;white-space:nowrap}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* SPLASH */
#splash{position:fixed;inset:0;z-index:1000;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:28px 24px 44px;overflow-y:auto}
#splash.hiding{animation:splashOut .4s ease forwards}
@keyframes splashOut{to{opacity:0;transform:scale(1.02);pointer-events:none}}
.splash-logo{font-family:'Playfair Display',serif;font-size:44px;color:var(--accent);margin-bottom:4px;animation:fadeUp .5s ease both}
.splash-tag{font-size:12px;color:var(--text3);letter-spacing:2px;text-transform:uppercase;margin-bottom:36px;animation:fadeUp .5s .1s ease both}
.onboard-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px;width:100%;max-width:360px;margin-bottom:14px;animation:fadeUp .5s .2s ease both}
.ob-row{display:flex;align-items:flex-start;gap:12px;margin-bottom:13px}
.ob-row:last-child{margin-bottom:0}
.ob-icon{width:34px;height:34px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.ob-icon.o{background:rgba(244,162,97,.15)} .ob-icon.g{background:rgba(82,183,136,.15)} .ob-icon.b{background:rgba(76,201,240,.15)} .ob-icon.r{background:rgba(230,57,70,.12)}
.ob-title{font-weight:600;font-size:13px;margin-bottom:2px}
.ob-desc{font-size:11px;color:var(--text3);line-height:1.4}
.splash-cta{width:100%;max-width:360px;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;border:none;padding:15px;border-radius:var(--radius-sm);font-family:'DM Sans',sans-serif;font-weight:700;font-size:15px;cursor:pointer;animation:fadeUp .5s .3s ease both}
.splash-ver{margin-top:12px;font-size:10px;color:var(--text3);animation:fadeUp .5s .35s ease both}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}

/* INSTALL BANNER */
#install-banner{display:none;position:fixed;bottom:86px;left:50%;transform:translateX(-50%);width:calc(100% - 28px);max-width:452px;background:var(--surface2);border:1px solid rgba(244,162,97,.2);border-radius:var(--radius);padding:13px 14px;z-index:150;box-shadow:0 8px 32px rgba(0,0,0,.4);align-items:center;gap:10px}
#install-banner.show{display:flex}
.ib-text{flex:1;font-size:12px;color:var(--text2);line-height:1.4}
.ib-text strong{color:var(--text);display:block;margin-bottom:1px;font-size:13px}
.ib-btn{background:var(--accent);color:#0f0f1a;border:none;padding:7px 13px;border-radius:20px;font-family:'DM Sans',sans-serif;font-weight:700;font-size:12px;cursor:pointer;white-space:nowrap}
.ib-close{background:none;border:none;color:var(--text3);font-size:19px;cursor:pointer;padding:0 3px}
.divider{height:1px;background:var(--border);margin:12px 0}

/* SWIPE CARDS */
#chit-swipe-wrap { width:100%; cursor:grab; }
#chit-swipe-wrap:active { cursor:grabbing; }
.swipe-card { min-width:100%; padding:0 2px; box-sizing:border-box; }
.swipe-card-inner { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:18px; position:relative; overflow:hidden; cursor:pointer; transition:transform .15s; }
.swipe-card-inner:active { transform:scale(.99); }
.swipe-card-inner::before { content:''; position:absolute; left:0; top:0; bottom:0; width:4px; background:var(--accent); border-radius:4px 0 0 4px; }
.swipe-card-inner.urgent::before { background:var(--red); }
.swipe-card-inner.warning::before { background:var(--yellow); }
.swipe-card-name { font-family:'Playfair Display',serif; font-size:20px; margin-bottom:14px; }
.swipe-card-stats { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:14px; }
.swipe-stat { background:var(--surface2); border-radius:var(--radius-sm); padding:11px 13px; }
.swipe-stat .lbl { font-size:10px; color:var(--text3); text-transform:uppercase; letter-spacing:.8px; margin-bottom:4px; }
.swipe-stat .val { font-family:'DM Mono',monospace; font-size:17px; }
.swipe-card-footer { display:flex; justify-content:space-between; align-items:center; margin-top:4px; }
.dot { width:7px; height:7px; border-radius:50%; background:var(--surface3); transition:all .25s; }
.dot.active { background:var(--accent); width:20px; border-radius:4px; }
.empty-swipe { background:var(--surface); border:1px dashed var(--border); border-radius:var(--radius); padding:40px 20px; text-align:center; min-width:100%; }
</style>
</head>
<body>

<!-- SPLASH -->
<div id="splash">
  <div class="splash-logo">ChitBook</div>
  <div class="splash-tag">Smart Chit Fund Organiser</div>
  <div class="onboard-card">
    <div class="ob-row"><div class="ob-icon o">üìÖ</div><div><div class="ob-title">Auction-Date Driven</div><div class="ob-desc">Set a fixed monthly auction date. App tracks payment deadlines automatically from that date.</div></div></div>
    <div class="ob-row"><div class="ob-icon b">üéØ</div><div><div class="ob-title">Smart Multi-Auction Engine</div><div class="ob-desc">Multiple auctions in one month when pool allows. Month advances automatically when threshold drops.</div></div></div>
    <div class="ob-row"><div class="ob-icon g">üì±</div><div><div class="ob-title">Auto WhatsApp Reminders</div><div class="ob-desc">Day 4 reminder alerts. Day 6 default alerts. Send to one or all members in one tap.</div></div></div>
    <div class="ob-row"><div class="ob-icon r">üëë</div><div><div class="ob-title">Organiser Payout Built In</div><div class="ob-desc">You receive the full chit value in your designated month ‚Äî no auction, no discount.</div></div></div>
  </div>
  <button class="splash-cta" onclick="launchApp()">Get Started ‚Üí</button>
  <div class="splash-ver">ChitBook v3.0 ¬∑ All data stored on your device</div>
</div>

<!-- INSTALL BANNER -->
<div id="install-banner">
  <div class="ib-text"><strong>Add to Home Screen</strong>Use ChitBook like a native app</div>
  <button class="ib-btn" onclick="installApp()">Install</button>
  <button class="ib-close" onclick="dismissInstall()">√ó</button>
</div>

<div class="header">
  <div><div class="logo">ChitBook<span>ORGANISER DASHBOARD</span></div></div>
  <button class="header-btn" onclick="showNewChitModal()">+ New Chit</button>
</div>
<div class="header-spacer"></div>

<div class="app">

  <!-- HOME -->
  <div id="page-home" class="page active">
    <div id="home-alerts"></div>
    <div class="summary-row">
      <div class="summary-card"><div class="lbl">Active Chits</div><div class="val accent" id="s-active">0</div></div>
      <div class="summary-card"><div class="lbl">Total Pool</div><div class="val green" id="s-pool">0</div></div>
      <div class="summary-card"><div class="lbl">Overdue (Day 4+)</div><div class="val yellow" id="s-overdue">0</div></div>
      <div class="summary-card"><div class="lbl">Defaults</div><div class="val red" id="s-defaults">0</div></div>
    </div>
    <div class="section-header">
      <div class="section-title" style="margin:0">Your Chits</div>
      <div id="chit-counter" style="font-size:12px;color:var(--text3)"></div>
    </div>
    <!-- SWIPE CARD CONTAINER -->
    <div id="chit-swipe-wrap" style="position:relative;overflow:hidden;touch-action:pan-y;">
      <div id="chit-cards-track" style="display:flex;transition:transform .3s ease;will-change:transform;"></div>
    </div>
    <div id="chit-dots" style="display:flex;justify-content:center;gap:7px;margin-top:12px;"></div>
  </div>

  <!-- DETAIL -->
  <div id="page-detail" class="page">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
      <button class="back-btn" style="margin:0" onclick="showHome()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 12H5M5 12l7 7M5 12l7-7"/></svg>All Chits
      </button>
      <button onclick="deleteChit()" style="background:none;border:none;color:var(--text3);font-size:12px;cursor:pointer;display:flex;align-items:center;gap:5px;padding:6px 10px;border-radius:20px;border:1px solid var(--border)">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6M10 11v6M14 11v6M9 6V4h6v2"/></svg>Delete Chit
      </button>
    </div>
    <div class="detail-hero">
      <div class="detail-title" id="d-name">‚Äî</div>
      <div class="detail-stats">
        <div class="detail-stat"><div class="lbl">Total Value</div><div class="val" id="d-value">‚Äî</div></div>
        <div class="detail-stat"><div class="lbl">Members</div><div class="val" id="d-members">‚Äî</div></div>
        <div class="detail-stat"><div class="lbl">Monthly</div><div class="val" id="d-monthly">‚Äî</div></div>
      </div>
      <div class="progress-wrap" style="margin-top:14px">
        <div class="progress-label"><span>Chits completed</span><span id="d-prog-lbl">0/0</span></div>
        <div class="progress-bar"><div class="progress-fill" id="d-prog-bar" style="width:0%"></div></div>
      </div>
    </div>
    <div class="pool-card">
      <div><div class="lbl">Accumulated Balance</div><div class="sub" id="d-pool-hint">‚Äî</div></div>
      <div class="amount" id="d-pool">‚Çπ0</div>
    </div>
    <div class="adate-card">
      <div>
        <div class="lbl">Auction Day ¬∑ Month <span id="d-month-num">1</span></div>
        <div class="dv" id="d-adate">‚Äî</div>
        <div class="ds" id="d-days-since">‚Äî</div>
      </div>
      <button class="header-btn" style="font-size:11px" onclick="openAuctionModal()">Conduct Auction</button>
    </div>
    <div id="detail-alerts"></div>
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('members')">Members</button>
      <button class="tab-btn" onclick="switchTab('auction')">Auctions</button>
      <button class="tab-btn" onclick="switchTab('reminders')">Reminders</button>
      <button class="tab-btn" onclick="switchTab('history')">History</button>
    </div>
    <div class="tab-pane active" id="tab-members">
      <div class="section-header">
        <div class="section-title" style="margin:0">Members</div>
        <button class="text-btn" onclick="showAddMemberModal()">+ Add</button>
      </div>
      <div class="month-tabs" id="month-tabs"></div>
      <div id="members-list"></div>
    </div>
    <div class="tab-pane" id="tab-auction">
      <div id="org-payout-section"></div>
      <div class="section-title">Auction Log</div>
      <div id="auction-log"></div>
    </div>
    <div class="tab-pane" id="tab-reminders">
      <div id="chit-reminders"></div>
    </div>
    <div class="tab-pane" id="tab-history">
      <div class="section-title">Transactions</div>
      <div id="history-list"></div>
    </div>
  </div>

  <!-- REMINDERS PAGE -->
  <div id="page-reminders" class="page">
    <div class="section-title" style="margin-bottom:14px">‚è∞ Reminders &amp; Alerts</div>
    <div id="reminders-content"></div>
  </div>

  <!-- REPORTS PAGE -->
  <div id="page-reports" class="page">
    <div class="section-title" style="margin-bottom:14px">üìä Reports</div>
    <div id="reports-content"></div>
  </div>
</div>

<!-- BOTTOM NAV -->
<div class="bottom-nav">
  <button class="nav-item active" id="nav-home" onclick="showHome()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>Home
  </button>
  <button class="nav-item" id="nav-reminders" onclick="showReminders()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9M13.73 21a2 2 0 01-3.46 0"/></svg>
    <span id="nav-badge" class="nav-badge" style="display:none">0</span>Alerts
  </button>
  <button class="nav-item" id="nav-reports" onclick="showReports()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>Reports
  </button>
</div>

<div class="toast" id="toast"></div>

<!-- MODALS -->
<div class="modal-overlay" id="modal-new-chit">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">Create New Chit</div>
    <div class="fg"><label class="fl">Chit Name</label><input type="text" class="fi" id="nc-name" placeholder="e.g. Office Chit 2025"></div>
    <div class="form-row">
      <div class="fg"><label class="fl">Total Value (‚Çπ)</label><input type="number" class="fi" id="nc-value" placeholder="100000"></div>
      <div class="fg"><label class="fl">No. of Members</label><input type="number" class="fi" id="nc-members" placeholder="20"></div>
    </div>
    <div class="form-row">
      <div class="fg"><label class="fl">Start Month</label><input type="month" class="fi" id="nc-start"></div>
      <div class="fg"><label class="fl">Auction Day</label><input type="number" class="fi" id="nc-aday" placeholder="e.g. 5" min="1" max="28"></div>
    </div>
    <div class="fg"><label class="fl">Your Payout Month (Organiser)</label><input type="number" class="fi" id="nc-orgmonth" placeholder="e.g. 3 ‚Äî you get full amount in Month 3" min="1"></div>
    <div class="info-box">üí° Auction happens on the set day each month. Members have 6 days to pay after auction. Day 4 = reminder. Day 6 = default. You (organiser) are Member 1 and receive the full chit value in your designated month with no auction.</div>
    <button class="btn-primary" onclick="createChit()">Create Chit</button>
    <button class="btn-secondary" onclick="closeModal('modal-new-chit')">Cancel</button>
  </div>
</div>

<div class="modal-overlay" id="modal-add-member">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">Add Member</div>
    <div style="display:flex;gap:6px;margin-bottom:14px">
      <button id="tab-single" class="tab active" style="flex:1;padding:7px;border-radius:8px;border:none;cursor:pointer;background:var(--accent);color:#fff;font-size:12px;font-weight:600" onclick="switchAddTab('single')">Single</button>
      <button id="tab-bulk" class="tab" style="flex:1;padding:7px;border-radius:8px;border:none;cursor:pointer;background:var(--surface2);color:var(--text2);font-size:12px;font-weight:600" onclick="switchAddTab('bulk')">Bulk Add</button>
    </div>
    <div id="add-single">
      <div class="fg"><label class="fl">Full Name</label><input type="text" class="fi" id="am-name" placeholder="Member's full name"></div>
      <div class="fg"><label class="fl">WhatsApp Number</label><input type="tel" class="fi" id="am-phone" placeholder="91XXXXXXXXXX (with country code)"></div>
      <div class="info-box">üì± Enter with country code for one-tap WhatsApp reminders.</div>
      <button class="btn-primary" onclick="addMember()">Add Member</button>
    </div>
    <div id="add-bulk" style="display:none">
      <div class="fg"><label class="fl">Member Names</label><textarea class="fi" id="am-bulk" rows="6" placeholder="Enter one name per line or separated by commas:&#10;Ravi&#10;Suresh&#10;Meena, Kumar&#10;Priya"></textarea></div>
      <div class="info-box">üìã Names separated by commas or new lines. Phone numbers can be added later.</div>
      <button class="btn-primary" onclick="addBulkMembers()">Add All Members</button>
    </div>
    <button class="btn-secondary" onclick="closeModal('modal-add-member')">Cancel</button>
  </div>
</div>

<div class="modal-overlay" id="modal-auction">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">Conduct Auction</div>
    <div class="info-box" id="a-pool-info"></div>
    <div class="fg"><label class="fl">Winner</label><select class="fi" id="a-member"></select></div>
    <div class="fg"><label class="fl">Bid Amount ‚Äî Discount Offered (‚Çπ)</label><input type="number" class="fi" id="a-bid" placeholder="e.g. 40000"></div>
    <div class="info-box">Payout to winner = <strong id="a-preview">‚Çπ‚Äî</strong> &nbsp;(Total Value ‚àí Bid)</div>
    <div class="auction-result" id="a-result"></div>
    <div id="auction-confirm" style="display:none;background:var(--surface2);border-radius:10px;padding:12px;margin-bottom:10px;font-size:13px;color:var(--text2)">
      <div style="font-weight:600;color:var(--accent);margin-bottom:6px">‚úÖ Confirm Auction</div>
      <div id="auction-confirm-text" style="margin-bottom:10px;line-height:1.7"></div>
      <div style="display:flex;gap:8px">
        <button class="btn-primary" style="flex:1;padding:10px" onclick="confirmAuction()">Confirm</button>
        <button class="btn-secondary" style="flex:1;padding:10px" onclick="cancelConfirm()">Edit</button>
      </div>
    </div>
    <button class="btn-primary" id="record-auction-btn" onclick="conductAuction()" disabled style="opacity:.4;cursor:not-allowed">Record Auction</button>
    <button class="btn-secondary" onclick="closeModal('modal-auction')">Close</button>
  </div>
</div>

<div class="modal-overlay" id="modal-member">
  <div class="modal">
    <div class="modal-handle"></div>
    <div id="member-modal-body"></div>
    <button class="btn-secondary" onclick="closeModal('modal-member')">Close</button>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let data = JSON.parse(localStorage.getItem('chitbook_v3') || '{"chits":[]}');
['chitbook_v2','chitbook'].forEach(k => {
  const old = localStorage.getItem(k);
  if (old && !data.chits.length) { try { const p=JSON.parse(old); if(p.chits?.length) data=p; } catch(e){} }
});
function save() { localStorage.setItem('chitbook_v3', JSON.stringify(data)); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function fmt(n) { return '‚Çπ' + Number(n).toLocaleString('en-IN'); }

function waIcon(s=13) {
  return `<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>`;
}

function showToast(msg, dur=2500) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), dur);
}

function getMonthLabel(offset, startMonth) {
  const [y,m] = startMonth.split('-').map(Number);
  return new Date(y, m-1+offset).toLocaleDateString('en-IN', {month:'short', year:'2-digit'});
}

function getAuctionDate(chit, monthIdx) {
  const [y,m] = chit.startMonth.split('-').map(Number);
  return new Date(y, m-1+monthIdx, chit.auctionDay);
}

function getAuctionDateStr(chit, monthIdx) {
  return getAuctionDate(chit, monthIdx).toLocaleDateString('en-IN', {day:'numeric', month:'short', year:'numeric'});
}

function daysSinceAuction(chit) {
  const a = getAuctionDate(chit, (chit.currentMonth||1)-1);
  const today = new Date(); today.setHours(0,0,0,0); a.setHours(0,0,0,0);
  return Math.floor((today - a) / 86400000);
}

// payment status for a member in a month index
function payStatus(chit, member, mIdx) {
  const p = member.payments[mIdx];
  if (p === true) return 'paid';
  if (p === 'default') return 'default';
  if (mIdx === (chit.currentMonth||1)-1) {
    const d = daysSinceAuction(chit);
    if (d >= 6) return 'overdue6';
    if (d >= 4) return 'overdue4';
  }
  return 'pending';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ALERTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getAlerts() {
  let overdue=0, defaults=0;
  data.chits.filter(c=>c.status==='active').forEach(chit => {
    const mIdx = (chit.currentMonth||1)-1;
    const d = daysSinceAuction(chit);
    chit.members.forEach(m => {
      const p = m.payments[mIdx];
      if (p==='default') defaults++;
      else if (p!==true && d>=4) overdue++;
    });
  });
  return {overdue, defaults};
}

function updateBadge() {
  const {overdue, defaults} = getAlerts();
  const total = overdue + defaults;
  const b = document.getElementById('nav-badge');
  b.style.display = total>0 ? 'flex' : 'none';
  b.textContent = total>9 ? '9+' : total;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NAV
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentChitId = null;
let viewMonth = 1;

function setNav(id) {
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('nav-'+id)?.classList.add('active');
  updateBadge();
}
function showPage(id) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
}
function showHome() { showPage('home'); setNav('home'); renderHome(); }
function showReminders() { showPage('reminders'); setNav('reminders'); renderRemindersPage(); }
function showReports() { showPage('reports'); setNav('reports'); renderReports(); }
function showDetail(chitId) {
  currentChitId = chitId;
  const chit = data.chits.find(c=>c.id===chitId);
  viewMonth = chit.currentMonth||1;
  showPage('detail'); switchTab('members'); renderDetail();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showNewChitModal() {
  document.getElementById('nc-start').value = new Date().toISOString().slice(0,7);
  ['nc-name','nc-value','nc-members','nc-aday','nc-orgmonth'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('modal-new-chit').classList.add('active');
}
function showAddMemberModal() {
  document.getElementById('am-name').value=''; document.getElementById('am-phone').value='';
  if (document.getElementById('am-bulk')) document.getElementById('am-bulk').value='';
  switchAddTab('single'); // always reset to single tab
  document.getElementById('modal-add-member').classList.add('active');
}
function closeModal(id) { document.getElementById(id).classList.remove('active'); }
document.querySelectorAll('.modal-overlay').forEach(o => {
  o.addEventListener('click', e => { if(e.target===o) o.classList.remove('active'); });
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CREATE CHIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function createChit() {
  const name = document.getElementById('nc-name').value.trim();
  const value = parseInt(document.getElementById('nc-value').value);
  const numMembers = parseInt(document.getElementById('nc-members').value);
  const startMonth = document.getElementById('nc-start').value;
  const auctionDay = parseInt(document.getElementById('nc-aday').value);
  const orgPayoutMonth = parseInt(document.getElementById('nc-orgmonth').value);
  if (!name||!value||!numMembers||!startMonth||!auctionDay||!orgPayoutMonth) { showToast('‚ö†Ô∏è Fill all fields'); return; }
  if (numMembers<2) { showToast('Need at least 2 members'); return; }
  if (auctionDay<1||auctionDay>28) { showToast('Auction day must be 1-28'); return; }

  const chit = {
    id: Date.now().toString(), name, value, numMembers,
    monthly: Math.floor(value/numMembers),
    startMonth, auctionDay, orgPayoutMonth,
    members: [], pool: 0, currentMonth: 1,
    completedChits: 0, transactions: [], auctions: [],
    status: 'active', orgPaidOut: false,
    lastPayoutAmount: null, auctionsThisMonth: 0,
    accumulatedDiscounts: value
  };
  // Organiser = member 1
  chit.members.push({id:'organiser', name:'Organiser (You)', phone:'', payments:{},
    receivedPayout:false, payoutMonth:null, payoutAmount:null, isOrganiser:true});

  data.chits.push(chit); save();
  closeModal('modal-new-chit');
  showToast('‚úÖ Chit created! You are Member 1.');
  showDetail(chit.id);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ADD MEMBER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchAddTab(tab) {
  document.getElementById('add-single').style.display = tab==='single' ? 'block' : 'none';
  document.getElementById('add-bulk').style.display = tab==='bulk' ? 'block' : 'none';
  document.getElementById('tab-single').style.background = tab==='single' ? 'var(--accent)' : 'var(--surface2)';
  document.getElementById('tab-single').style.color = tab==='single' ? '#fff' : 'var(--text2)';
  document.getElementById('tab-bulk').style.background = tab==='bulk' ? 'var(--accent)' : 'var(--surface2)';
  document.getElementById('tab-bulk').style.color = tab==='bulk' ? '#fff' : 'var(--text2)';
}

function addBulkMembers() {
  const chit = data.chits.find(c=>c.id===currentChitId);
  const raw = document.getElementById('am-bulk').value.trim();
  if (!raw) { showToast('Enter at least one name'); return; }
  // Split by newline or comma
    const names = raw.split(/[\r\n,]+/).map(n=>n.trim()).filter(n=>n.length>0);
  const slots = chit.numMembers - chit.members.length;
  if (names.length > slots) { showToast(`Only ${slots} slot(s) remaining ‚Äî adding first ${slots}`); }
  const toAdd = names.slice(0, slots);
  toAdd.forEach(name => {
    chit.members.push({id: Date.now().toString()+Math.random().toString(36).slice(2),
      name, phone:'', payments:{},
      receivedPayout:false, payoutMonth:null, payoutAmount:null, isOrganiser:false});
  });
  save(); closeModal('modal-add-member');
  showToast(`‚úÖ ${toAdd.length} member(s) added`);
  renderDetail();
}

function addMember() {
  const name = document.getElementById('am-name').value.trim();
  const phone = document.getElementById('am-phone').value.trim();
  if (!name) { showToast('Enter member name'); return; }
  const chit = data.chits.find(c=>c.id===currentChitId);
  if (chit.members.length>=chit.numMembers) { showToast('Member limit reached!'); return; }
  chit.members.push({id:Date.now().toString(), name, phone, payments:{},
    receivedPayout:false, payoutMonth:null, payoutAmount:null, isOrganiser:false});
  save(); closeModal('modal-add-member');
  showToast('‚úÖ '+name+' added'); renderDetail();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PAYMENTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function recordPayment(memberId, mIdx) {
  const chit = data.chits.find(c=>c.id===currentChitId);
  const member = chit.members.find(m=>m.id===memberId);
  if (member.payments[mIdx]===true) { showToast('Already marked paid'); return; }
  member.payments[mIdx] = true;
  chit.pool += chit.monthly;
  chit.transactions.push({type:'in', desc:member.name+' ‚Äî Contribution',
    amount:chit.monthly, month:mIdx, date:new Date().toLocaleDateString('en-IN')});
  save(); showToast('‚úÖ '+fmt(chit.monthly)+' from '+member.name);
  renderDetail(); updateBadge();
}

function markDefault(memberId, mIdx) {
  const chit = data.chits.find(c=>c.id===currentChitId);
  chit.members.find(m=>m.id===memberId).payments[mIdx] = 'default';
  save(); showToast('‚ö†Ô∏è Marked defaulted'); renderDetail(); updateBadge();
}

function undoDefault(memberId, mIdx) {
  const chit = data.chits.find(c=>c.id===currentChitId);
  delete chit.members.find(m=>m.id===memberId).payments[mIdx];
  save(); showToast('Default cleared'); renderDetail();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AUCTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openAuctionModal() {
  const chit = data.chits.find(c=>c.id===currentChitId);
  if (chit.currentMonth === chit.orgPayoutMonth && !chit.orgPaidOut) {
    showToast('Month '+chit.orgPayoutMonth+' is your payout month ‚Äî go to Auctions tab');
    switchTab('auction');
    return;
  }
  const accDisc = chit.accumulatedDiscounts || 0;
  const lastPayout = chit.lastPayoutAmount; // null = first auction of month
  const thresholdNote = lastPayout
    ? `2nd auction possible if balance ‚â• last payout ${fmt(lastPayout)}`
    : `2nd auction check happens after this payout is recorded`;
  document.getElementById('a-pool-info').innerHTML =
    `Month ${chit.currentMonth} ¬∑ Auction #${(chit.auctionsThisMonth||0)+1}<br>
     Accumulated Balance: <strong style="color:var(--accent)">${fmt(accDisc)}</strong>
     &nbsp;|&nbsp; Payout = <strong>${fmt(chit.value)}</strong> ‚àí Bid<br>
     <span style="color:var(--text3);font-size:11px">${thresholdNote}</span>`;
  const eligible = chit.members.filter(m=>!m.isOrganiser && !m.receivedPayout);
  document.getElementById('a-member').innerHTML = '<option value="">Select winner...</option>' +
    eligible.map(m=>`<option value="${m.id}">${m.name}</option>`).join('');
  document.getElementById('a-bid').value = '';
  document.getElementById('a-preview').textContent = '‚Çπ‚Äî';
  document.getElementById('a-result').style.display = 'none';
  const recBtn2 = document.getElementById('record-auction-btn');
  if (recBtn2) { recBtn2.disabled=true; recBtn2.style.opacity='.4'; recBtn2.style.cursor='not-allowed'; recBtn2.style.display='block'; }
  const confirmBox2 = document.getElementById('auction-confirm');
  if (confirmBox2) confirmBox2.style.display='none';
  document.getElementById('a-preview').textContent = '‚Çπ‚Äî';
  document.getElementById('a-result').style.display = 'none';
  document.getElementById('modal-auction').classList.add('active');
}

document.addEventListener('input', e => {
  if (e.target.id==='a-bid' || e.target.id==='a-member') {
    const chit = data.chits.find(c=>c.id===currentChitId);
    const bid = parseInt(document.getElementById('a-bid').value)||0;
    const member = document.getElementById('a-member').value;
    // Update payout preview
    if (e.target.id==='a-bid') {
      document.getElementById('a-preview').textContent = (chit && bid>0) ? fmt(chit.value-bid) : '‚Çπ‚Äî';
    }
    // Enable/disable Record Auction button
    const btn = document.getElementById('record-auction-btn');
    if (btn) {
      const valid = member && bid > 0 && bid < (chit ? chit.value : Infinity);
      btn.disabled = !valid;
      btn.style.opacity = valid ? '1' : '.4';
      btn.style.cursor = valid ? 'pointer' : 'not-allowed';
    }
  }
});

function cancelConfirm() {
  document.getElementById('auction-confirm').style.display = 'none';
  document.getElementById('record-auction-btn').style.display = 'block';
}

function confirmAuction() {
  document.getElementById('auction-confirm').style.display = 'none';
  document.getElementById('record-auction-btn').style.display = 'block';
  proceedAuction();
}

function conductAuction() {
  const chit = data.chits.find(c=>c.id===currentChitId);
  // Hard block ‚Äî no auction in organiser's payout month
  if (chit.currentMonth === chit.orgPayoutMonth && !chit.orgPaidOut) {
    showToast('‚ö†Ô∏è Month '+chit.orgPayoutMonth+' is your payout month ‚Äî no member auction!');
    closeModal('modal-auction');
    return;
  }
  const memberId = document.getElementById('a-member').value;
  const bid = parseInt(document.getElementById('a-bid').value);
  if (!memberId) { showToast('Select a winner'); return; }
  if (!bid||bid<=0||bid>=chit.value) { showToast('Enter valid bid (< '+fmt(chit.value)+')'); return; }
  const member = chit.members.find(m=>m.id===memberId);
  const payout0 = chit.value - bid;
  // Show custom in-app confirmation
  const confirmBox = document.getElementById('auction-confirm');
  document.getElementById('auction-confirm-text').innerHTML =
    `Winner: <strong>${member.name}</strong><br>Bid: <strong>${fmt(bid)}</strong> &nbsp;|&nbsp; Payout: <strong>${fmt(payout0)}</strong>`;
  confirmBox.style.display = 'block';
  document.getElementById('record-auction-btn').style.display = 'none';
  // store for proceedAuction
  window._pendingAuction = {chitId: currentChitId, memberId, bid};
}

function proceedAuction() {
  const {chitId, memberId, bid} = window._pendingAuction || {};
  const chit = data.chits.find(c=>c.id===chitId);
  if (!chit) return;
  const member = chit.members.find(m=>m.id===memberId);
  if (!member) return;
  const payout = chit.value - bid;

  // acc -= payout after each auction
  chit.accumulatedDiscounts = (chit.accumulatedDiscounts||0) - payout;

  member.receivedPayout = true;
  member.payoutMonth = chit.currentMonth;
  member.payoutAmount = payout;
  chit.completedChits += 1;
  chit.lastPayoutAmount = payout;
  chit.auctionsThisMonth = (chit.auctionsThisMonth||0)+1;
  const aNo = chit.auctionsThisMonth;

  chit.auctions.push({
    memberId, memberName:member.name, bid, payout,
    month:chit.currentMonth, auctionNo:aNo,
    accDiscountsAfter:chit.accumulatedDiscounts,
    date:new Date().toLocaleDateString('en-IN')
  });
  chit.transactions.push({
    type:'out',
    desc:`Payout ‚Äî ${member.name} (M${chit.currentMonth} ¬∑ Auction ${aNo})`,
    amount:payout, month:chit.currentMonth,
    date:new Date().toLocaleDateString('en-IN')
  });

  if (chit.completedChits>=chit.numMembers) chit.status='complete';

  const res = document.getElementById('a-result');
  res.style.display = 'block';

  // CORRECT LOGIC:
  // accumulatedDiscounts grows by adding each bid ‚Äî never deducted
  // Second auction condition: accumulatedDiscounts >= last payout amount
  // This naturally works because discounts accumulate across months
  const canMore = chit.accumulatedDiscounts >= payout && chit.status !== 'complete';

  if (chit.status==='complete') {
    save();
    // Calculate adjusted last month contribution
    const accBalance = chit.accumulatedDiscounts;
    const shortfall = payout - accBalance; // positive = shortfall, negative = windfall
    const adjustedMsg = shortfall === 0
      ? ''
      : shortfall > 0
        ? `<br><br>üìã <strong>Last month collection:</strong> Pool short by ${fmt(shortfall)}.<br>Collect <strong>${fmt(Math.ceil((chit.monthly * chit.numMembers + shortfall) / chit.numMembers))}</strong> from each member this month (‚Çπ${fmt(chit.monthly)} + ‚Çπ${fmt(Math.ceil(shortfall/chit.numMembers))} extra each).`
        : `<br><br>üìã <strong>Last month collection:</strong> Pool has surplus of ${fmt(Math.abs(shortfall))}.<br>Collect only <strong>${fmt(Math.floor((chit.monthly * chit.numMembers + shortfall) / chit.numMembers))}</strong> from each member this month (‚Çπ${fmt(chit.monthly)} ‚àí ‚Çπ${fmt(Math.floor(Math.abs(shortfall)/chit.numMembers))} less each).`;
    res.innerHTML = `<strong>${member.name}</strong> wins. Payout: <strong>${fmt(payout)}</strong>${adjustedMsg}<br><br>üéâ <strong>All chits completed!</strong>`;
    // Disable button ‚Äî chit is done
    const doneBtn = document.getElementById('record-auction-btn');
    if (doneBtn) { doneBtn.disabled=true; doneBtn.style.opacity='.4'; doneBtn.style.cursor='not-allowed'; doneBtn.textContent='Chit Complete ‚úì'; }
    showToast('üéâ All done!');
  } else if (!canMore) {
    // Advance month ‚Äî not enough accumulated discounts for another auction
    const prev = chit.currentMonth;
    const accAfterPayout = chit.accumulatedDiscounts; // acc AFTER payout, BEFORE next month's addition
    chit.currentMonth += 1;
    chit.auctionsThisMonth = 0;
    chit.lastPayoutAmount = null;
    // Add chit value for new month ‚Äî acc carries forward and grows each month
    chit.accumulatedDiscounts = accAfterPayout + chit.value;
    viewMonth = chit.currentMonth;
    save();
    res.innerHTML = `<strong>${member.name}</strong> wins Auction ${aNo} of Month ${prev}.<br>
      Bid: ${fmt(bid)} &nbsp;|&nbsp; Payout: <strong>${fmt(payout)}</strong><br>
      Accumulated after payout: <strong>${fmt(accAfterPayout)}</strong><br><br>
      üìÖ Not enough for 2nd auction ‚Üí <strong>Month ${chit.currentMonth} started.</strong><br>
      Next auction on ${getAuctionDateStr(chit, chit.currentMonth-1)}.`;
    // Auction done for this month ‚Äî disable button, no more recording possible
    const doneBtn = document.getElementById('record-auction-btn');
    if (doneBtn) { doneBtn.disabled=true; doneBtn.style.opacity='.4'; doneBtn.style.cursor='not-allowed'; doneBtn.textContent='Auction Recorded ‚úì'; }
    showToast('üìÖ Month '+chit.currentMonth+' started');
  } else {
    // Second auction possible ‚Äî accumulated discounts >= last payout
    const discColor = 'var(--green)';
    save();
    document.getElementById('a-pool-info').innerHTML =
      `Month ${chit.currentMonth} ¬∑ Auction #${aNo+1}<br>
       Accumulated Discounts: <strong style="color:${discColor}">${fmt(chit.accumulatedDiscounts)}</strong><br>
       <span style="color:var(--green)">‚úÖ Second auction possible (discounts ‚â• last payout ${fmt(payout)})</span>`;
    const eligible = chit.members.filter(m=>!m.isOrganiser&&!m.receivedPayout);
    document.getElementById('a-member').innerHTML = '<option value="">Select winner...</option>'+
      eligible.map(m=>`<option value="${m.id}">${m.name}</option>`).join('');
    document.getElementById('a-bid').value='';
    document.getElementById('a-preview').textContent='‚Çπ‚Äî';
    document.getElementById('a-result').style.display='none';
    // Re-disable button until new fields are filled
    const recBtn = document.getElementById('record-auction-btn');
    if (recBtn) { recBtn.disabled=true; recBtn.style.opacity='.4'; recBtn.style.cursor='not-allowed'; }
    res.innerHTML = `<strong>${member.name}</strong> wins Auction ${aNo} of Month ${chit.currentMonth}.<br>
      Bid: ${fmt(bid)} &nbsp;|&nbsp; Payout: <strong>${fmt(payout)}</strong><br>
      Accumulated discounts: <strong style="color:${discColor}">${fmt(chit.accumulatedDiscounts)}</strong><br><br>
      ‚úÖ <strong>Second auction possible this month!</strong> Select next winner below.`;
    showToast('‚úÖ Auction '+aNo+' done ‚Äî second auction possible!');
  }
  renderDetail();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ORGANISER PAYOUT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function takeOrgPayout() {
  const chit = data.chits.find(c=>c.id===currentChitId);
  if (chit.orgPaidOut) { showToast('Already collected'); return; }
  // Organiser always collects full value ‚Äî pool balance is just informational
  const org = chit.members.find(m=>m.isOrganiser);
  org.receivedPayout = true;
  org.payoutMonth = chit.currentMonth;
  org.payoutAmount = chit.value;
  chit.orgPaidOut = true;
  chit.completedChits += 1;
  // Organiser payout is completely separate from member auction ‚Äî no pool deduction
  // It comes from accumulated discounts, independent of what month's auction does
  chit.transactions.push({
    type:'out',
    desc:'Organiser Payout (no auction) ‚Äî Month '+chit.currentMonth,
    amount:chit.value, month:chit.currentMonth,
    date:new Date().toLocaleDateString('en-IN')
  });
  if (chit.completedChits>=chit.numMembers) {
    chit.status = 'complete';
    save();
    showToast('üéâ Collected '+fmt(chit.value)+'! All chits complete!');
  } else {
    // Advance month automatically ‚Äî no member auction in org payout month
    chit.currentMonth += 1;
    chit.auctionsThisMonth = 0;
    chit.lastPayoutAmount = null;
    // Org payout deducts chit value, new month adds chit value ‚Äî net: just add chit value
    chit.accumulatedDiscounts = (chit.accumulatedDiscounts||0) - chit.value + chit.value;
    viewMonth = chit.currentMonth;
    save();
    showToast('üéâ Collected '+fmt(chit.value)+'! Month '+chit.currentMonth+' started.');
  }
  renderDetail();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  WHATSAPP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function sendWA(phone, msg) {
  window.open('https://wa.me/'+phone.replace(/\D/g,'')+`?text=${encodeURIComponent(msg)}`);
}
function buildReminderMsg(chit, member) {
  const d = daysSinceAuction(chit);
  const aDate = getAuctionDateStr(chit,(chit.currentMonth||1)-1);
  return `Hello ${member.name} üôè\n\nReminder for *${chit.name}* chit fund.\n\nüìÖ Auction: ${aDate} (${d} days ago)\nüí∞ Due: *${fmt(chit.monthly)}*\n\nPlease pay within ${6-d} day(s) to avoid default.\n\n_ChitBook_`;
}
function buildDefaultMsg(chit, member) {
  return `Hello ${member.name},\n\nYour contribution to *${chit.name}* is overdue.\n\nüí∞ Overdue: *${fmt(chit.monthly)}*\n\nPlease contact the organiser immediately.\n\n_ChitBook_`;
}
function buildSummaryMsg(chit) {
  const mIdx=(chit.currentMonth||1)-1;
  const pending=chit.members.filter(m=>!m.payments[mIdx]);
  const defs=chit.members.filter(m=>m.payments[mIdx]==='default');
  return `*ChitBook ‚Äî ${chit.name}*\nüìÖ Month ${chit.currentMonth} | Auction: ${getAuctionDateStr(chit,mIdx)}\nüí∞ Pool: *${fmt(chit.pool)}*\n‚úÖ Completed: ${chit.completedChits}/${chit.numMembers}`+
    (pending.length?`\n‚è≥ Pending: ${pending.map(m=>m.name).join(', ')}`:'')+(defs.length?`\n‚ö†Ô∏è Defaulted: ${defs.map(m=>m.name).join(', ')}`:'');
}
function sendReminder(chitId, memberId) {
  const chit=data.chits.find(c=>c.id===chitId); const m=chit.members.find(m=>m.id===memberId);
  if(!m.phone){showToast('No phone for '+m.name);return;} sendWA(m.phone,buildReminderMsg(chit,m));
}
function sendDefaultAlert(chitId, memberId) {
  const chit=data.chits.find(c=>c.id===chitId); const m=chit.members.find(m=>m.id===memberId);
  if(!m.phone){showToast('No phone for '+m.name);return;} sendWA(m.phone,buildDefaultMsg(chit,m));
}
function sendAllPending(chitId) {
  const chit=data.chits.find(c=>c.id===chitId); const mIdx=(chit.currentMonth||1)-1;
  const list=chit.members.filter(m=>!m.payments[mIdx]&&m.phone);
  list.forEach((m,i)=>setTimeout(()=>sendWA(m.phone,buildReminderMsg(chit,m)),i*600));
  showToast('Opening WhatsApp for '+list.length+' members‚Ä¶');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MEMBER MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showMemberDetail(chitId, memberId) {
  const chit=data.chits.find(c=>c.id===chitId); const m=chit.members.find(m=>m.id===memberId);
  const paid=Object.values(m.payments||{}).filter(v=>v===true).length;
  const defs=Object.values(m.payments||{}).filter(v=>v==='default').length;
  const mIdx=(chit.currentMonth||1)-1; const days=daysSinceAuction(chit); const ps=m.payments[mIdx];
  const hasPaid = Object.values(m.payments||{}).some(v=>v===true||v==='default');
  const canDelete = !m.isOrganiser && !m.receivedPayout && !hasPaid;
  let html=`<div class="modal-title">${m.isOrganiser?'üëë ':''}${m.name}</div>
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
      <div class="avatar ${m.isOrganiser?'org':''}" style="width:44px;height:44px;font-size:17px">${m.isOrganiser?'üëë':m.name.charAt(0).toUpperCase()}</div>
      <div><div style="font-size:13px;color:var(--text2)">${m.phone||'No phone'}</div>
      <div style="font-size:11px;color:var(--text3);margin-top:2px">${paid} paid ¬∑ ${defs} defaults ¬∑ ${m.receivedPayout?'‚úÖ Got '+fmt(m.payoutAmount):'‚è≥ Awaiting payout'}</div></div>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:12px">
      ${!m.isOrganiser?`<button class="header-btn" style="flex:1" onclick="renameMember('${chitId}','${memberId}')">‚úèÔ∏è Rename</button>`:''}
      ${canDelete?`<button class="header-btn" style="flex:1;color:var(--red);border-color:rgba(230,57,70,.3)" onclick="deleteMember('${chitId}','${memberId}')">üóëÔ∏è Delete</button>`:''}
    </div>`;
  if (m.phone) {
    if (ps!==true&&ps!=='default') html+=`<button class="whatsapp-btn" onclick="sendReminder('${chitId}','${memberId}');closeModal('modal-member')">${waIcon()} Send Reminder (Day ${days})</button>`;
    if (ps==='default') html+=`<button class="whatsapp-btn" style="background:rgba(230,57,70,.1);color:var(--red);border-color:rgba(230,57,70,.2)" onclick="sendDefaultAlert('${chitId}','${memberId}');closeModal('modal-member')">${waIcon()} Send Default Alert</button>`;
  }
  document.getElementById('member-modal-body').innerHTML=html;
  document.getElementById('modal-member').classList.add('active');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MEMBER RENAME & DELETE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renameMember(chitId, memberId) {
  const chit = data.chits.find(c=>c.id===chitId);
  const m = chit.members.find(m=>m.id===memberId);
  const newName = prompt('Rename member:', m.name);
  if (!newName || !newName.trim()) return;
  m.name = newName.trim();
  save(); renderDetail(); closeModal('modal-member');
  showToast('‚úì Renamed to '+m.name);
}

function deleteMember(chitId, memberId) {
  const chit = data.chits.find(c=>c.id===chitId);
  const m = chit.members.find(m=>m.id===memberId);
  // Block delete if member has any history
  const hasPaid = Object.values(m.payments||{}).some(v=>v===true||v==='default');
  const hasWon = m.receivedPayout;
  if (hasPaid || hasWon) {
    showToast('‚ö†Ô∏è Cannot delete ‚Äî member has payment history');
    return;
  }
  if (!confirm('Delete '+m.name+'? This cannot be undone.')) return;
  chit.members = chit.members.filter(mb=>mb.id!==memberId);
  chit.numMembers = chit.members.length;
  save(); renderDetail(); closeModal('modal-member');
  showToast('Deleted '+m.name);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SWIPE CARDS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let swipeIndex = 0;
let swipeStartX = 0;
let swipeStartY = 0;
let swipeDragging = false;
let swipeTotal = 0;

function initSwipe() {
  const wrap = document.getElementById('chit-swipe-wrap');
  if (!wrap) return;
  wrap.addEventListener('touchstart', e => {
    swipeStartX = e.touches[0].clientX;
    swipeStartY = e.touches[0].clientY;
    swipeDragging = true;
  }, {passive:true});
  wrap.addEventListener('touchmove', e => {
    if (!swipeDragging) return;
    const dx = e.touches[0].clientX - swipeStartX;
    const dy = e.touches[0].clientY - swipeStartY;
    if (Math.abs(dx) > Math.abs(dy)) {
      const track = document.getElementById('chit-cards-track');
      track.style.transition = 'none';
      track.style.transform = `translateX(calc(-${swipeIndex * 100}% + ${dx}px))`;
    }
  }, {passive:true});
  wrap.addEventListener('touchend', e => {
    if (!swipeDragging) return;
    swipeDragging = false;
    const dx = e.changedTouches[0].clientX - swipeStartX;
    if (dx < -50 && swipeIndex < swipeTotal - 1) swipeIndex++;
    else if (dx > 50 && swipeIndex > 0) swipeIndex--;
    goToSwipeCard(swipeIndex);
  }, {passive:true});
  // Mouse drag for desktop
  let mouseDown = false, mouseStartX = 0;
  wrap.addEventListener('mousedown', e => { mouseDown=true; mouseStartX=e.clientX; });
  wrap.addEventListener('mousemove', e => {
    if (!mouseDown) return;
    const dx = e.clientX - mouseStartX;
    const track = document.getElementById('chit-cards-track');
    track.style.transition = 'none';
    track.style.transform = `translateX(calc(-${swipeIndex * 100}% + ${dx}px))`;
  });
  wrap.addEventListener('mouseup', e => {
    if (!mouseDown) return; mouseDown=false;
    const dx = e.clientX - mouseStartX;
    if (dx < -50 && swipeIndex < swipeTotal - 1) swipeIndex++;
    else if (dx > 50 && swipeIndex > 0) swipeIndex--;
    goToSwipeCard(swipeIndex);
  });
  wrap.addEventListener('mouseleave', e => {
    if (!mouseDown) return; mouseDown=false;
    goToSwipeCard(swipeIndex);
  });
}

function goToSwipeCard(idx) {
  swipeIndex = idx;
  const track = document.getElementById('chit-cards-track');
  track.style.transition = 'transform .3s ease';
  track.style.transform = `translateX(-${idx * 100}%)`;
  document.querySelectorAll('.dot').forEach((d,i) => d.classList.toggle('active', i===idx));
  const counter = document.getElementById('chit-counter');
  if (counter && swipeTotal > 0) counter.textContent = (idx+1) + ' / ' + swipeTotal;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER HOME
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderHome() {
  const active=data.chits.filter(c=>c.status==='active');
  const totalPool=data.chits.reduce((s,c)=>s+(c.pool||0),0);
  const {overdue,defaults}=getAlerts();
  document.getElementById('s-active').textContent=active.length;
  document.getElementById('s-pool').textContent=fmt(totalPool);
  document.getElementById('s-overdue').textContent=overdue;
  document.getElementById('s-defaults').textContent=defaults;

  let alertHtml='';
  if (defaults>0) alertHtml+=`<div class="alert-box red" onclick="showReminders()"><div class="alert-icon">‚ö†Ô∏è</div><div><div class="alert-title red">${defaults} Member(s) Defaulted</div><div class="alert-desc">Tap to send default alerts</div></div></div>`;
  if (overdue>0) alertHtml+=`<div class="alert-box yellow" onclick="showReminders()"><div class="alert-icon">‚è∞</div><div><div class="alert-title yellow">${overdue} Payment(s) Overdue (Day 4+)</div><div class="alert-desc">Tap to send reminders</div></div></div>`;
  document.getElementById('home-alerts').innerHTML=alertHtml;

  const track = document.getElementById('chit-cards-track');
  const dots = document.getElementById('chit-dots');
  const counter = document.getElementById('chit-counter');

  if (!data.chits.length) {
    track.innerHTML=`<div class="empty-swipe"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity:.2;margin-bottom:12px"><rect x="3" y="3" width="18" height="18" rx="3"/><path d="M3 9h18M9 21V9"/></svg><div style="font-family:'Playfair Display',serif;font-size:16px;color:var(--text2);margin-bottom:6px">No chits yet</div><div style="font-size:13px;color:var(--text3)">Tap "+ New Chit" above to get started</div></div>`;
    dots.innerHTML=''; counter.textContent='';
    return;
  }

  swipeTotal = data.chits.length;

  track.innerHTML = data.chits.map(chit => {
    const mIdx=(chit.currentMonth||1)-1; const d=daysSinceAuction(chit);
    const pending=chit.members.filter(m=>!m.payments[mIdx]&&m.payments[mIdx]!=='default').length;
    const defs=chit.members.filter(m=>m.payments[mIdx]==='default').length;
    const pct=Math.round((chit.completedChits/chit.numMembers)*100);
    const aDate=getAuctionDateStr(chit,mIdx);
    let urg=''; let badge=`<span class="badge green">Active</span>`;
    if (defs>0){urg='urgent';badge=`<span class="badge red">‚ö†Ô∏è ${defs} Defaulted</span>`;}
    else if (d>=4&&pending>0){urg='warning';badge=`<span class="badge yellow">Day ${d} ‚Äî ${pending} Pending</span>`;}
    else if (chit.status==='complete'){urg='';badge=`<span class="badge grey">Complete</span>`;}

    let statusLine = '';
    if (d===0) statusLine=`<span style="color:var(--green);font-size:12px">üü¢ Auction day today!</span>`;
    else if (d<0) statusLine=`<span style="color:var(--blue);font-size:12px">üìÖ Auction in ${Math.abs(d)} day(s) ‚Äî ${aDate}</span>`;
    else if (d>=6) statusLine=`<span style="color:var(--red);font-size:12px">üö® Day ${d} ‚Äî defaults overdue!</span>`;
    else if (d>=4) statusLine=`<span style="color:var(--yellow);font-size:12px">‚è∞ Day ${d} ‚Äî send reminders!</span>`;
    else statusLine=`<span style="color:var(--text3);font-size:12px">Day ${d} after auction ¬∑ ${aDate}</span>`;

    return `<div class="swipe-card">
      <div class="swipe-card-inner ${urg}" onclick="showDetail('${chit.id}')">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:4px">
          <div class="swipe-card-name">${chit.name}</div>
          ${badge}
        </div>
        <div style="margin-bottom:14px">${statusLine}</div>
        <div class="swipe-card-stats">
          <div class="swipe-stat"><div class="lbl">Pool Balance</div><div class="val accent">${fmt(chit.pool)}</div></div>
          <div class="swipe-stat"><div class="lbl">Monthly</div><div class="val">${fmt(chit.monthly)}</div></div>
          <div class="swipe-stat"><div class="lbl">Members Paid</div><div class="val green">${chit.members.filter(m=>m.payments[mIdx]===true).length}/${chit.members.length}</div></div>
          <div class="swipe-stat"><div class="lbl">Chits Done</div><div class="val">${chit.completedChits}/${chit.numMembers}</div></div>
        </div>
        <div class="progress-wrap" style="margin-bottom:12px">
          <div class="progress-label"><span>Overall progress</span><span>${pct}%</span></div>
          <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
        </div>
        <div style="text-align:center;font-size:11px;color:var(--text3)">Tap to open ¬∑ Swipe to browse</div>
      </div>
    </div>`;
  }).join('');

  dots.innerHTML = data.chits.map((_,i) =>
    `<div class="dot ${i===swipeIndex?'active':''}" onclick="goToSwipeCard(${i})"></div>`
  ).join('');

  // Keep current position or reset if out of bounds
  if (swipeIndex >= swipeTotal) swipeIndex = swipeTotal - 1;
  goToSwipeCard(swipeIndex);
  initSwipe();
  updateBadge();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER DETAIL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDetail() {
  const chit=data.chits.find(c=>c.id===currentChitId); if(!chit)return;
  const mIdx=(chit.currentMonth||1)-1; const d=daysSinceAuction(chit);

  document.getElementById('d-name').textContent=chit.name;
  document.getElementById('d-value').textContent=fmt(chit.value);
  document.getElementById('d-members').textContent=chit.members.length+'/'+chit.numMembers;
  document.getElementById('d-monthly').textContent=fmt(chit.monthly)+'/mo';
  document.getElementById('d-pool').textContent=fmt(chit.accumulatedDiscounts||0);
  document.getElementById('d-month-num').textContent=chit.currentMonth||1;
  document.getElementById('d-prog-lbl').textContent=chit.completedChits+'/'+chit.numMembers;
  document.getElementById('d-prog-bar').style.width=Math.round((chit.completedChits/chit.numMembers)*100)+'%';

  const threshold=chit.lastPayoutAmount||chit.value;
  // Pool = cash collected from member payments (informational)
  // Accumulated discounts = sum of all bids = what decides second auction
  const accDisc = chit.accumulatedDiscounts || 0;
  const lastPayout = chit.lastPayoutAmount || chit.value;
  const canSecond = accDisc >= lastPayout;
  document.getElementById('d-pool-hint').textContent = canSecond
    ? `‚úÖ 2nd auction possible (balance ${fmt(accDisc)} ‚â• last payout ${fmt(lastPayout)})`
    : `Balance ${fmt(accDisc)} ‚Äî need ${fmt(lastPayout - accDisc)} more for 2nd auction`;
  document.getElementById('d-pool').style.color = 'var(--accent)';

  document.getElementById('d-adate').textContent=getAuctionDateStr(chit,mIdx);
  // Hide conduct auction button in organiser's payout month
  const isOrgMonth = chit.currentMonth === chit.orgPayoutMonth && !chit.orgPaidOut;
  const btnWrap = document.getElementById('conduct-auction-btn-wrap');
  if (btnWrap) btnWrap.style.display = isOrgMonth ? 'none' : 'block';
  let dsText='',dsColor='var(--text3)';
  if(d===0){dsText='üü¢ Auction day today!';}
  else if(d<0){dsText=`Next auction in ${Math.abs(d)} day(s)`;}
  else if(d>=6){dsText=`üö® Day ${d} ‚Äî Defaults overdue!`;dsColor='var(--red)';}
  else if(d>=4){dsText=`üü° Day ${d} ‚Äî Send reminders now!`;dsColor='var(--yellow)';}
  else{dsText=`Day ${d} after auction ‚Äî collecting payments`;}
  const dsEl=document.getElementById('d-days-since');
  dsEl.textContent=dsText; dsEl.style.color=dsColor;

  // Alerts
  let alerts='';
  if(d>=6){const u=chit.members.filter(m=>!m.payments[mIdx]||m.payments[mIdx]==='default');
    if(u.length)alerts+=`<div class="alert-box red" onclick="switchTab('reminders')"><div class="alert-icon">üö®</div><div><div class="alert-title red">Day ${d} ‚Äî ${u.length} member(s) should be defaulted</div><div class="alert-desc">Go to Reminders tab</div></div></div>`;}
  else if(d>=4){const u=chit.members.filter(m=>!m.payments[mIdx]);
    if(u.length)alerts+=`<div class="alert-box yellow" onclick="switchTab('reminders')"><div class="alert-icon">‚è∞</div><div><div class="alert-title yellow">Day ${d} ‚Äî Send reminders to ${u.length} member(s)</div><div class="alert-desc">Go to Reminders tab</div></div></div>`;}
  if(chit.currentMonth>=chit.orgPayoutMonth&&!chit.orgPaidOut)
    alerts+=`<div class="alert-box blue" onclick="switchTab('auction')"><div class="alert-icon">üëë</div><div><div class="alert-title blue">Your Payout Month!</div><div class="alert-desc">Go to Auctions tab to collect ${fmt(chit.value)}</div></div></div>`;
  document.getElementById('detail-alerts').innerHTML=alerts;

  // Month tabs
  document.getElementById('month-tabs').innerHTML=Array.from({length:chit.currentMonth||1},(_,i)=>
    `<button class="month-tab ${i+1===viewMonth?'active':''}" onclick="selectMonth(${i+1})">${getMonthLabel(i,chit.startMonth)}</button>`
  ).join('');

  renderMembersTab(chit);
  renderAuctionTab(chit);
  renderChitReminders(chit);
  renderHistoryTab(chit);
}

function renderMembersTab(chit) {
  const vIdx=viewMonth-1; const d=daysSinceAuction(chit);
  document.getElementById('members-list').innerHTML=chit.members.map(m=>{
    const ps=payStatus(chit,m,vIdx); const isOrg=m.isOrganiser;
    let rowCls=isOrg?'org-row':'';
    if(ps==='overdue6')rowCls+=' overdue6'; else if(ps==='overdue4')rowCls+=' overdue4';
    const payoutTag=m.receivedPayout?`<span class="payout-badge">üèÜ</span>`:'';
    let right='';
    if(ps==='paid'){right=`<span class="paid-badge">‚úì Paid</span>${payoutTag}`;}
    else if(ps==='default'){right=`<span class="def-badge">Defaulted</span><button class="undo-btn" onclick="undoDefault('${m.id}',${vIdx})">‚Ü©</button>${m.phone?`<button class="wa-btn" onclick="sendDefaultAlert('${currentChitId}','${m.id}')">${waIcon()}</button>`:''}`;}
    else if(ps==='overdue6'){right=`<span class="def-badge">Day ${d}!</span><button class="def-btn" onclick="markDefault('${m.id}',${vIdx})">Default</button>${m.phone?`<button class="wa-btn" onclick="sendDefaultAlert('${currentChitId}','${m.id}')">${waIcon()}</button>`:''}`;}
    else if(ps==='overdue4'){right=`<span class="overdue-badge">Day ${d}</span><button class="pay-btn" onclick="recordPayment('${m.id}',${vIdx})">Paid</button>${m.phone?`<button class="wa-btn" onclick="sendReminder('${currentChitId}','${m.id}')">${waIcon()}</button>`:''}`;}
    else{right=`${payoutTag}<button class="pay-btn" onclick="recordPayment('${m.id}',${vIdx})">Mark Paid</button><button class="def-btn" onclick="markDefault('${m.id}',${vIdx})">!</button>${m.phone?`<button class="wa-btn" onclick="sendReminder('${currentChitId}','${m.id}')">${waIcon()}</button>`:''}`;}
    return `<div class="member-row ${rowCls}">
      <div class="member-info" onclick="showMemberDetail('${currentChitId}','${m.id}')">
        <div class="avatar ${isOrg?'org':ps==='default'||ps==='overdue6'?'def':''}">${isOrg?'üëë':m.name.charAt(0).toUpperCase()}</div>
        <div><div class="member-name">${m.name}</div>
        <div class="member-sub">${m.phone||'No phone'}${m.receivedPayout?' ¬∑ üèÜ Got '+fmt(m.payoutAmount):''}</div></div>
      </div>
      <div class="member-actions">${right}</div></div>`;
  }).join('');
}

function renderAuctionTab(chit) {
  let orgHtml='';
  if(chit.currentMonth>=chit.orgPayoutMonth&&!chit.orgPaidOut){
    orgHtml=`<div class="org-box">
      <div style="font-family:'Playfair Display',serif;font-size:16px;color:var(--accent);margin-bottom:4px">üëë Your Payout ‚Äî Month ${chit.orgPayoutMonth}</div>
      <div style="font-size:12px;color:var(--text2);margin-bottom:6px">Completely <strong>separate from the member auction</strong>. Auction proceeds normally this month ‚Äî you also collect your full amount independently.</div>
      <div style="font-size:11px;color:var(--text3);margin-bottom:12px">No bidding. No discount. Full ${fmt(chit.value)} to you as organiser.</div>
      <button class="btn-primary" style="margin:0" onclick="takeOrgPayout()">Collect My Payout ‚Äî ${fmt(chit.value)}</button>
    </div>`;
  } else if(chit.orgPaidOut){
    orgHtml=`<div class="alert-box green" style="margin-bottom:14px"><div class="alert-icon">üëë</div><div><div class="alert-title green">Organiser Payout Collected</div><div class="alert-desc">${fmt(chit.value)} received in Month ${chit.orgPayoutMonth}</div></div></div>`;
  }
  document.getElementById('org-payout-section').innerHTML=orgHtml;

  const log=document.getElementById('auction-log');
  if(!chit.auctions.length){log.innerHTML=`<div style="text-align:center;padding:24px;color:var(--text3);font-size:13px">No auctions yet.</div>`;return;}
  log.innerHTML=chit.auctions.slice().reverse().map(a=>
    `<div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:13px;margin-bottom:8px">
      <div style="display:flex;justify-content:space-between;margin-bottom:5px">
        <div style="font-weight:600;font-size:13px">${a.memberName}</div>
        <div style="font-family:'DM Mono',monospace;font-size:13px;color:var(--accent)">${fmt(a.payout)}</div>
      </div>
      <div style="font-size:11px;color:var(--text3)">Month ${a.month} ¬∑ Auction ${a.auctionNo} ¬∑ Bid: ${fmt(a.bid)} ¬∑ Acc. Discounts after: ${fmt(a.accDiscountsAfter||0)} ¬∑ ${a.date}</div>
    </div>`
  ).join('');
}

function renderChitReminders(chit) {
  const mIdx=(chit.currentMonth||1)-1; const d=daysSinceAuction(chit);
  const defs=chit.members.filter(m=>m.payments[mIdx]==='default');
  const pending=chit.members.filter(m=>!m.payments[mIdx]&&m.payments[mIdx]!=='default');
  const paid=chit.members.filter(m=>m.payments[mIdx]===true);
  const uc=d>=6?'var(--red)':d>=4?'var(--yellow)':'var(--text2)';

  let html=`<div style="display:flex;gap:7px;margin-bottom:14px;flex-wrap:wrap">
    <span class="badge green">‚úì ${paid.length} paid</span>
    <span class="badge yellow">‚è≥ ${pending.length} pending</span>
    <span class="badge red">‚ö†Ô∏è ${defs.length} defaulted</span>
    <span class="badge grey">Day ${d} after auction</span>
  </div>`;

  if(defs.length){
    html+=`<div style="font-weight:600;color:var(--red);font-size:13px;margin-bottom:8px">‚ö†Ô∏è Defaulted</div>`;
    html+=`<div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px;margin-bottom:12px">`;
    html+=defs.map(m=>`<div class="rem-row">
      <div><div style="font-size:13px">${m.name}</div><div style="font-size:11px;color:var(--text3)">${m.phone||'No phone'}</div></div>
      <div style="display:flex;gap:6px;align-items:center">
        <span style="font-family:'DM Mono',monospace;font-size:12px;color:var(--red)">${fmt(chit.monthly)}</span>
        ${m.phone?`<button class="wa-text-btn" onclick="sendDefaultAlert('${chit.id}','${m.id}')">${waIcon()} Alert</button>`:''}
      </div></div>`).join('');
    html+=`</div>`;
  }

  if(pending.length){
    html+=`<div style="font-weight:600;color:${uc};font-size:13px;margin-bottom:8px">‚è≥ Pending${d>=4?' ‚Äî Day '+d:''}</div>`;
    html+=`<div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px;margin-bottom:12px">`;
    html+=pending.map(m=>`<div class="rem-row">
      <div><div style="font-size:13px">${m.name}</div><div style="font-size:11px;color:var(--text3)">${m.phone||'No phone'}</div></div>
      <div style="display:flex;gap:6px;align-items:center">
        <span style="font-family:'DM Mono',monospace;font-size:12px;color:${uc}">${fmt(chit.monthly)}</span>
        ${m.phone?`<button class="wa-text-btn" onclick="sendReminder('${chit.id}','${m.id}')">${waIcon()} Remind</button>`:''}
        ${d>=6?`<button class="def-btn" onclick="markDefault('${m.id}',${mIdx})">Default</button>`:''}
      </div></div>`).join('');
    if(pending.filter(m=>m.phone).length>1)
      html+=`<button class="send-all-btn" onclick="sendAllPending('${chit.id}')">${waIcon(14)} Remind All ${pending.filter(m=>m.phone).length} Members</button>`;
    html+=`</div>`;
  }

  if(!defs.length&&!pending.length) html=`<div style="text-align:center;padding:20px;color:var(--green);font-size:14px">üéâ All members paid this month!</div>`+html;
  html+=`<button class="send-all-btn" style="background:var(--surface2);color:var(--text2);border-color:var(--border)" onclick="window.open('https://wa.me/?text='+encodeURIComponent(buildSummaryMsg(data.chits.find(c=>c.id==='${chit.id}'))))">${waIcon(14)} Share Group Summary</button>`;
  document.getElementById('chit-reminders').innerHTML=html;
}

function renderHistoryTab(chit) {
  const el=document.getElementById('history-list');
  if(!chit.transactions.length){el.innerHTML=`<div style="text-align:center;padding:24px;color:var(--text3);font-size:13px">No transactions yet</div>`;return;}
  el.innerHTML=chit.transactions.slice().reverse().map(t=>
    `<div class="hist-row"><div class="h-dot ${t.type}"></div>
    <div class="h-desc">${t.desc}<div class="h-sub">${t.date}</div></div>
    <div class="h-amt ${t.type}">${t.type==='in'?'+':'‚àí'}${fmt(t.amount)}</div></div>`
  ).join('');
}

function selectMonth(m) {
  viewMonth=m;
  document.querySelectorAll('.month-tab').forEach((t,i)=>t.classList.toggle('active',i===m-1));
  renderMembersTab(data.chits.find(c=>c.id===currentChitId));
}

function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab-pane').forEach(t=>t.classList.remove('active'));
  const map={members:0,auction:1,reminders:2,history:3};
  document.querySelectorAll('.tab-btn')[map[tab]]?.classList.add('active');
  document.getElementById('tab-'+tab)?.classList.add('active');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  REMINDERS PAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderRemindersPage() {
  const el=document.getElementById('reminders-content');
  const active=data.chits.filter(c=>c.status==='active');
  if(!active.length){el.innerHTML=`<div class="empty-state"><h3>No active chits</h3></div>`;return;}
  let html=''; let any=false;
  active.forEach(chit=>{
    const mIdx=(chit.currentMonth||1)-1; const d=daysSinceAuction(chit);
    const defs=chit.members.filter(m=>m.payments[mIdx]==='default');
    const pending=chit.members.filter(m=>!m.payments[mIdx]&&m.payments[mIdx]!=='default');
    if(!defs.length&&(pending.length===0||d<4))return;
    any=true;
    html+=`<div style="font-family:'Playfair Display',serif;font-size:15px;margin-bottom:10px">${chit.name} <span style="font-family:'DM Sans',sans-serif;font-size:11px;color:var(--text3)">Day ${d}</span></div>`;
    if(defs.length){
      html+=`<div style="background:var(--surface);border:1px solid rgba(230,57,70,.2);border-radius:var(--radius-sm);padding:12px;margin-bottom:10px">
        <div style="font-weight:600;color:var(--red);font-size:13px;margin-bottom:8px">‚ö†Ô∏è Defaulted (${defs.length})</div>
        ${defs.map(m=>`<div class="rem-row">
          <div><div style="font-size:13px">${m.name}</div><div style="font-size:11px;color:var(--text3)">${m.phone||'No phone'}</div></div>
          <div style="display:flex;gap:6px;align-items:center">
            <span style="font-family:'DM Mono',monospace;font-size:12px;color:var(--red)">${fmt(chit.monthly)}</span>
            ${m.phone?`<button class="wa-text-btn" onclick="sendDefaultAlert('${chit.id}','${m.id}')">${waIcon()} Alert</button>`:''}
          </div></div>`).join('')}</div>`;}
    if(pending.length&&d>=4){
      html+=`<div style="background:var(--surface);border:1px solid rgba(255,209,102,.2);border-radius:var(--radius-sm);padding:12px;margin-bottom:10px">
        <div style="font-weight:600;color:var(--yellow);font-size:13px;margin-bottom:8px">‚è≥ Pending ‚Äî Day ${d} (${pending.length})</div>
        ${pending.map(m=>`<div class="rem-row">
          <div><div style="font-size:13px">${m.name}</div><div style="font-size:11px;color:var(--text3)">${m.phone||'No phone'}</div></div>
          <div style="display:flex;gap:6px;align-items:center">
            <span style="font-family:'DM Mono',monospace;font-size:12px;color:var(--yellow)">${fmt(chit.monthly)}</span>
            ${m.phone?`<button class="wa-text-btn" onclick="sendReminder('${chit.id}','${m.id}')">${waIcon()} Remind</button>`:''}
            ${d>=6?`<button class="def-btn" onclick="currentChitId='${chit.id}';markDefault('${m.id}',${mIdx})">Default</button>`:''}
          </div></div>`).join('')}
        ${pending.filter(m=>m.phone).length>1?`<button class="send-all-btn" onclick="sendAllPending('${chit.id}')">${waIcon(14)} Remind All</button>`:''}
      </div>`;}
    html+=`<div class="divider"></div>`;
  });
  if(!any) html=`<div style="text-align:center;padding:40px 20px"><div style="font-size:36px;margin-bottom:12px">üéâ</div><div style="font-family:'Playfair Display',serif;font-size:17px;margin-bottom:6px">All Clear!</div><div style="font-size:13px;color:var(--text3)">No overdue payments or defaults right now.</div></div>`;
  el.innerHTML=html;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  REPORTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderReports() {
  const el=document.getElementById('reports-content');
  if(!data.chits.length){el.innerHTML=`<div class="empty-state"><h3>No data yet</h3></div>`;return;}
  el.innerHTML=data.chits.map(chit=>{
    const tIn=chit.transactions.filter(t=>t.type==='in').reduce((s,t)=>s+t.amount,0);
    const tOut=chit.transactions.filter(t=>t.type==='out').reduce((s,t)=>s+t.amount,0);
    const mIdx=(chit.currentMonth||1)-1;
    const defs=chit.members.filter(m=>m.payments[mIdx]==='default').length;
    const pct=Math.round((chit.completedChits/chit.numMembers)*100);
    return `<div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:14px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
        <div style="font-family:'Playfair Display',serif;font-size:16px">${chit.name}</div>
        <span class="badge ${chit.status==='active'?'green':'grey'}">${chit.status==='active'?'Active':'Complete'}</span>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:14px">
        <div><div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.6px">Total In</div><div style="font-family:'DM Mono',monospace;font-size:15px;color:var(--green);margin-top:3px">${fmt(tIn)}</div></div>
        <div><div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.6px">Total Out</div><div style="font-family:'DM Mono',monospace;font-size:15px;color:var(--accent);margin-top:3px">${fmt(tOut)}</div></div>
        <div><div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.6px">Pool Now</div><div style="font-family:'DM Mono',monospace;font-size:15px;color:var(--accent);margin-top:3px">${fmt(chit.pool)}</div></div>
        <div><div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.6px">Auctions</div><div style="font-family:'DM Mono',monospace;font-size:15px;margin-top:3px">${chit.completedChits}/${chit.numMembers}</div></div>
        <div><div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.6px">Month</div><div style="font-family:'DM Mono',monospace;font-size:15px;margin-top:3px">${chit.currentMonth}</div></div>
        <div><div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.6px">Defaults</div><div style="font-family:'DM Mono',monospace;font-size:15px;color:${defs>0?'var(--red)':'var(--text)'};margin-top:3px">${defs}</div></div>
      </div>
      <div class="progress-wrap" style="margin-bottom:12px">
        <div class="progress-label"><span>Progress</span><span>${pct}%</span></div>
        <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
      </div>
      <button class="whatsapp-btn" onclick="window.open('https://wa.me/?text='+encodeURIComponent(buildSummaryMsg(data.chits.find(c=>c.id==='${chit.id}'))))">${waIcon()} Share Status Update</button>
    </div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SPLASH + PWA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function launchApp() {
  const s=document.getElementById('splash');
  s.classList.add('hiding');
  setTimeout(()=>{
    s.style.display='none';
    localStorage.setItem('chitbook_launched','1');
    setTimeout(()=>{
      if(window._deferredInstall&&!localStorage.getItem('chitbook_install_dismissed'))
        document.getElementById('install-banner').classList.add('show');
    },3000);
  },400);
}
function initApp() {
  renderHome();
  if(localStorage.getItem('chitbook_launched')) document.getElementById('splash').style.display='none';
}
window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();window._deferredInstall=e;});
function installApp() {
  if(window._deferredInstall){window._deferredInstall.prompt();window._deferredInstall.userChoice.then(()=>dismissInstall());}
  else{showToast('Tap Share ‚Üí Add to Home Screen',4000);dismissInstall();}
}
function dismissInstall() {
  document.getElementById('install-banner').classList.remove('show');
  localStorage.setItem('chitbook_install_dismissed','1');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DELETE CHIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function deleteChit() {
  const chit = data.chits.find(c=>c.id===currentChitId);
  if (!chit) return;
  if (!confirm(`Delete "${chit.name}"?\n\nThis will permanently remove all members, payments, auctions and history. This cannot be undone.`)) return;
  data.chits = data.chits.filter(c=>c.id!==currentChitId);
  save();
  showToast('Chit deleted');
  showHome();
}

initApp();
</script>
</body>
</html>